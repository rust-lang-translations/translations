<!DOCTYPE HTML>
<html lang="ko" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>최적화: 속도와 크기의 트레이드오프 - The Embedded Rust Book</title>


        <!-- Custom HTML head -->

        <script async src="https://www.googletagmanager.com/gtag/js?id=G-L455DH98TK"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-L455DH98TK');
        </script>
        
        
        <script>
            (function () {
                // See these pages for details:
                // https://developers.google.com/search/docs/crawling-indexing/consolidate-duplicate-urls
                // https://developers.google.com/search/docs/crawling-indexing/javascript/javascript-seo-basics
        
                function gen_canonical_href(lang) {
        
                    let base = "https://rust-lang-translations.org/embedded-book";
        
                    let canonical_href;
                    if (lang == "en") {
                        canonical_href = `${base}/unsorted/speed-vs-size.md`;
                    } else {
                        canonical_href = `${base}/${lang}/unsorted/speed-vs-size.md`;
                    }
                    canonical_href = canonical_href.slice(0, -"md".length) + "html";
                    if (canonical_href.endsWith("/index.html")) {
                        canonical_href = canonical_href.slice(0, -"index.html".length);
                    }
                    return canonical_href;
                }
        
                const canonical_href = gen_canonical_href("ko");

                let link = document.createElement("link");
                link.rel = "canonical";
                link.href = canonical_href;
                document.head.appendChild(link);
        
        
                const langs = ["en"  , "ko" ];
        
                for (const lang of langs) {
                    const canonical_href = gen_canonical_href(lang);
        
                    let link = document.createElement("link");
                    link.rel = "alternate";
                    link.hreflang = lang;
                    link.href = canonical_href;
                    document.head.appendChild(link);
                }
            })()
        </script>
        

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/language-picker.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Embedded Rust Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang-translations/project" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="최적화-속도와-크기의-트레이드오프"><a class="header" href="#최적화-속도와-크기의-트레이드오프">최적화: 속도와 크기의 트레이드오프</a></h1>
<p>모든 사람은 자신의 프로그램이 매우 빠르고 매우 작기를 원하지만 일반적으로 두 가지 특성을 모두 갖는 것은 불가능합니다. 이 섹션에서는 <code>rustc</code>가 제공하는 다양한 최적화 수준과 이러한 수준이 프로그램의 실행 시간 및 바이너리 크기에 미치는 영향에 대해 설명합니다.</p>
<h2 id="최적화-없음"><a class="header" href="#최적화-없음">최적화 없음</a></h2>
<p>이것이 기본값입니다. <code>cargo build</code>를 호출하면 개발(일명 <code>dev</code>) 프로필을 사용합니다. 이 프로필은 디버깅에 최적화되어 있으므로 디버그 정보를 활성화하고 최적화를 활성화하지 않습니다. 즉, <code>-C opt-level = 0</code>을 사용합니다.</p>
<p>적어도 베어메탈 개발의 경우, 디버그 정보는 플래시/ROM 공간을 차지하지 않는다는 점에서 비용이 없습니다. 따라서 릴리스 프로필에서 디버그 정보를 활성화하는 것이 좋습니다. 기본적으로 비활성화되어 있습니다. 이렇게 하면 릴리스 빌드를 디버깅할 때 중단점을 사용할 수 있습니다.</p>
<pre><code class="language-toml">[profile.release]
# symbols are nice and they don't increase the size on Flash
debug = true
</code></pre>
<p>최적화가 없으면 코드를 한 문장씩 실행하는 것처럼 느껴지기 때문에 디버깅에 좋습니다. 또한 GDB에서 스택 변수와 함수 인수를 <code>print</code>할 수 있습니다. 코드가 최적화되면 변수를 인쇄하려고 하면 <code>$0 = &lt;value optimized out&gt;</code>이 인쇄됩니다.</p>
<p><code>dev</code> 프로필의 가장 큰 단점은 결과 바이너리가 거대하고 느리다는 것입니다. 최적화되지 않은 바이너리는 수십 KiB의 플래시를 차지할 수 있으며 대상 장치에 없을 수 있으므로 크기가 일반적으로 더 큰 문제입니다. 결과: 최적화되지 않은 바이너리가 장치에 맞지 않습니다!</p>
<p>더 작고 디버거 친화적인 바이너리를 가질 수 있을까요? 예, 비결이 있습니다.</p>
<h3 id="종속성-최적화"><a class="header" href="#종속성-최적화">종속성 최적화</a></h3>
<p><a href="https://doc.rust-lang.org/cargo/reference/profiles.html#overrides"><code>profile-overrides</code></a>라는 Cargo 기능이 있어 종속성의 최적화 수준을 재정의할 수 있습니다. 이 기능을 사용하여 모든 종속성을 크기에 맞게 최적화하면서 최상위 크레이트는 최적화되지 않고 디버거 친화적으로 유지할 수 있습니다.</p>
<p>제네릭 코드는 정의된 크레이트가 아닌 인스턴스화된 크레이트와 함께 최적화될 수 있다는 점에 유의하십시오. 애플리케이션에서 제네릭 구조체의 인스턴스를 만들고 큰 공간을 차지하는 코드를 가져오는 경우 관련 종속성의 최적화 수준을 높여도 효과가 없을 수 있습니다.</p>
<p>다음은 예시입니다.</p>
<pre><code class="language-toml"># Cargo.toml
[package]
name = "app"
# ..

[profile.dev.package."*"] # +
opt-level = "z" # +
</code></pre>
<p>재정의 없이:</p>
<pre><code class="language-text">$ cargo size --bin app -- -A
app  :
section               size        addr
.vector_table         1024   0x8000000
.text                 9060   0x8000400
.rodata               1708   0x8002780
.data                    0  0x20000000
.bss                     4  0x20000000
</code></pre>
<p>재정의 포함:</p>
<pre><code class="language-text">$ cargo size --bin app -- -A
app  :
section               size        addr
.vector_table         1024   0x8000000
.text                 3490   0x8000400
.rodata               1100   0x80011c0
.data                    0  0x20000000
.bss                     4  0x20000000
</code></pre>
<p>최상위 크레이트의 디버깅 가능성을 잃지 않고 플래시 사용량이 6KiB 감소했습니다. 종속성으로 들어가면 <code>&lt;value optimized out&gt;</code> 메시지가 다시 표시되지만 일반적으로 종속성이 아닌 최상위 크레이트를 디버그하려는 경우입니다. 그리고 종속성을 디버그해야 하는 경우 <code>profile-overrides</code> 기능을 사용하여 특정 종속성을 최적화에서 제외할 수 있습니다. 아래 예제를 참조하십시오.</p>
<pre><code class="language-toml"># ..

# don't optimize the `cortex-m-rt` crate
[profile.dev.package.cortex-m-rt] # +
opt-level = 0 # +

# but do optimize all the other dependencies
[profile.dev.package."*"]
codegen-units = 1 # better optimizations
opt-level = "z"
</code></pre>
<p>이제 최상위 크레이트와 <code>cortex-m-rt</code>는 디버거 친화적입니다!</p>
<h2 id="속도-최적화"><a class="header" href="#속도-최적화">속도 최적화</a></h2>
<p>2018-09-18 기준으로 <code>rustc</code>는 세 가지 "속도 최적화" 수준을 지원합니다: <code>opt-level = 1</code>, <code>2</code> 및 <code>3</code>. <code>cargo build --release</code>를 실행하면 기본적으로 <code>opt-level = 3</code>인 릴리스 프로필을 사용합니다.</p>
<p><code>opt-level = 2</code>와 <code>3</code> 모두 바이너리 크기를 희생하여 속도를 최적화하지만, 수준 <code>3</code>은 수준 <code>2</code>보다 더 많은 벡터화 및 인라이닝을 수행합니다. 특히 <code>opt-level</code>이 <code>2</code> 이상이면 LLVM이 루프를 언롤링하는 것을 볼 수 있습니다. 루프 언롤링은 플래시/ROM 측면에서 비용이 상당히 높지만(예: 이 배열 루프를 0으로 만드는 데 26바이트에서 194바이트로) 올바른 조건(예: 반복 횟수가 충분히 큼)이 주어지면 실행 시간을 절반으로 줄일 수도 있습니다.</p>
<p>현재 <code>opt-level = 2</code> 및 <code>3</code>에서 루프 언롤링을 비활성화할 방법이 없으므로 비용을 감당할 수 없다면 프로그램을 크기에 맞게 최적화해야 합니다.</p>
<h2 id="크기-최적화"><a class="header" href="#크기-최적화">크기 최적화</a></h2>
<p>2018-09-18 기준으로 <code>rustc</code>는 두 가지 "크기 최적화" 수준을 지원합니다: <code>opt-level = "s"</code> 및 <code>"z"</code>. 이 이름들은 clang / LLVM에서 상속되었으며 그다지 설명적이지는 않지만 <code>"z"</code>는 <code>"s"</code>보다 작은 바이너리를 생성한다는 아이디어를 제공하기 위한 것입니다.</p>
<p>릴리스 바이너리를 크기에 맞게 최적화하려면 아래와 같이 <code>Cargo.toml</code>에서 <code>profile.release.opt-level</code> 설정을 변경하십시오.</p>
<pre><code class="language-toml">[profile.release]
# or "z"
opt-level = "s"
</code></pre>
<p>These two optimization levels greatly reduce LLVM's inline threshold, a metric used to decide whether to inline a function or not. One of Rust principles are zero cost abstractions; these abstractions tend to use a lot of newtypes and small functions to hold invariants (e.g. functions that borrow an inner value like <code>deref</code>, <code>as_ref</code>) so a low inline threshold can make LLVM miss optimization opportunities (e.g. eliminate dead branches, inline calls to closures).</p>
<p>When optimizing for size you may want to try increasing the inline threshold to see if that has any effect on the binary size. The recommended way to change the inline threshold is to append the <code>-C inline-threshold</code> flag to the other rustflags in <code>.cargo/config.toml</code>.</p>
<pre><code class="language-toml"># .cargo/config.toml
# this assumes that you are using the cortex-m-quickstart template
[target.'cfg(all(target_arch = "arm", target_os = "none"))']
rustflags = [
  # ..
  "-C", "inline-threshold=123", # +
]
</code></pre>
<p>What value to use? <a href="https://github.com/rust-lang/rust/blob/1.29.0/src/librustc_codegen_llvm/back/write.rs#L2105-L2122">As of 1.29.0 these are the inline thresholds that the different optimization levels use</a>:</p>
<ul>
<li><code>opt-level = 3</code> uses 275</li>
<li><code>opt-level = 2</code> uses 225</li>
<li><code>opt-level = "s"</code> uses 75</li>
<li><code>opt-level = "z"</code> uses 25</li>
</ul>
<p>You should try <code>225</code> and <code>275</code> when optimizing for size.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../unsorted/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../unsorted/math.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../unsorted/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../unsorted/math.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../theme/language-picker.js"></script>


    </div>
    </body>
</html>
