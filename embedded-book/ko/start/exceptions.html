<!DOCTYPE HTML>
<html lang="ko" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>예외 - The Embedded Rust Book</title>


        <!-- Custom HTML head -->

        <script async src="https://www.googletagmanager.com/gtag/js?id=G-L455DH98TK"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-L455DH98TK');
        </script>
        
        
        <script>
            (function () {
                // See these pages for details:
                // https://developers.google.com/search/docs/crawling-indexing/consolidate-duplicate-urls
                // https://developers.google.com/search/docs/crawling-indexing/javascript/javascript-seo-basics
        
                function gen_canonical_href(lang) {
        
                    let base = "https://rust-lang-translations.org/embedded-book";
        
                    let canonical_href;
                    if (lang == "en") {
                        canonical_href = `${base}/start/exceptions.md`;
                    } else {
                        canonical_href = `${base}/${lang}/start/exceptions.md`;
                    }
                    canonical_href = canonical_href.slice(0, -"md".length) + "html";
                    if (canonical_href.endsWith("/index.html")) {
                        canonical_href = canonical_href.slice(0, -"index.html".length);
                    }
                    return canonical_href;
                }
        
                const canonical_href = gen_canonical_href("ko");

                let link = document.createElement("link");
                link.rel = "canonical";
                link.href = canonical_href;
                document.head.appendChild(link);
        
        
                const langs = ["en"  , "ko" ];
        
                for (const lang of langs) {
                    const canonical_href = gen_canonical_href(lang);
        
                    let link = document.createElement("link");
                    link.rel = "alternate";
                    link.hreflang = lang;
                    link.href = canonical_href;
                    document.head.appendChild(link);
                }
            })()
        </script>
        

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/language-picker.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Embedded Rust Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang-translations/project" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="예외"><a class="header" href="#예외">예외</a></h1>
<p>예외 및 인터럽트는 프로세서가 비동기 이벤트 및 치명적인 오류(예: 잘못된 명령어 실행)를 처리하는 하드웨어 메커니즘입니다. 예외는 선점을 의미하며 이벤트를 트리거한 신호에 대한 응답으로 실행되는 서브루틴인 예외 처리기를 포함합니다.</p>
<p><code>cortex-m-rt</code> 크레이트는 예외 처리기를 선언하는 <a href="https://docs.rs/cortex-m-rt-macros/latest/cortex_m_rt_macros/attr.exception.html"><code>exception</code></a> 속성을 제공합니다.</p>
<pre><code class="language-rust ignore">// SysTick(시스템 타이머) 예외에 대한 예외 처리기
#[exception]
fn SysTick() {
    // ..
}</code></pre>
<p><code>exception</code> 속성 외에 예외 처리기는 일반 함수처럼 보이지만 한 가지 차이점이 더 있습니다. <code>exception</code> 처리기는 소프트웨어에서 호출할 수 <em>없습니다</em>. 이전 예에 따라 <code>SysTick();</code> 문은 컴파일 오류를 발생시킵니다.</p>
<p>이 동작은 거의 의도된 것이며 기능을 제공하는 데 필요합니다. <code>exception</code> 처리기 _내부_에 선언된 <code>static mut</code> 변수는 <em>안전하게</em> 사용할 수 있습니다.</p>
<pre><code class="language-rust ignore">#[exception]
fn SysTick() {
    static mut COUNT: u32 = 0;

    // `COUNT`는 `&amp;mut u32` 유형으로 변환되었으며 안전하게 사용할 수 있습니다
    *COUNT += 1;
}</code></pre>
<p>아시다시피 함수에서 <code>static mut</code> 변수를 사용하면 <a href="https://en.wikipedia.org/wiki/Reentrancy_(computing)"><em>비재진입</em></a>이 됩니다. 둘 이상의 예외/인터럽트 처리기 또는 <code>main</code> 및 하나 이상의 예외/인터럽트 처리기에서 직접 또는 간접적으로 비재진입 함수를 호출하는 것은 정의되지 않은 동작입니다.</p>
<p>안전한 Rust는 정의되지 않은 동작을 초래해서는 안 되므로 비재진입 함수는 <code>unsafe</code>로 표시해야 합니다. 하지만 방금 <code>exception</code> 처리기가 <code>static mut</code> 변수를 안전하게 사용할 수 있다고 말했습니다. 어떻게 이것이 가능할까요? <code>exception</code> 처리기는 소프트웨어에서 호출할 수 <em>없으므로</em> 재진입이 불가능하기 때문입니다. 이러한 처리기는 물리적으로 비동시적이라고 가정되는 하드웨어 자체에서 호출됩니다.</p>
<p>결과적으로 임베디드 시스템의 예외 처리기 컨텍스트에서 동일한 처리기의 동시 호출이 없으면 처리기가 정적 가변 변수를 사용하더라도 재진입 문제가 발생하지 않습니다.</p>
<p>여러 프로세서 코어가 코드를 동시에 실행하는 멀티코어 시스템에서는 예외 처리기 내에서도 재진입 문제의 가능성이 다시 관련됩니다. 각 코어에 자체 예외 처리기 세트가 있을 수 있지만 여러 코어가 동시에 동일한 예외 처리기를 실행하려고 시도하는 시나리오가 여전히 있을 수 있습니다. 멀티코어 환경에서 이 문제를 해결하려면 예외 처리기 내에서 적절한 동기화 메커니즘을 사용하여 코어 간에 공유 리소스에 대한 액세스가 적절하게 조정되도록 해야 합니다. 여기에는 일반적으로 잠금, 세마포어 또는 원자적 연산과 같은 기술을 사용하여 데이터 경쟁을 방지하고 데이터 무결성을 유지하는 것이 포함됩니다.</p>
<blockquote>
<p><code>exception</code> 속성은 함수 내의 정적 변수 정의를 <code>unsafe</code> 블록으로 래핑하고 동일한 이름의 <code>&amp;mut</code> 유형의 새 적절한 변수를 제공하여 변환합니다. 따라서 <code>unsafe</code> 블록으로 래핑할 필요 없이 <code>*</code>를 통해 참조를 역참조하여 변수 값에 액세스할 수 있습니다.</p>
</blockquote>
<h2 id="완전한-예시"><a class="header" href="#완전한-예시">완전한 예시</a></h2>
<p>다음은 시스템 타이머를 사용하여 약 1초마다 <code>SysTick</code> 예외를 발생시키는 예입니다. <code>SysTick</code> 예외 처리기는 <code>COUNT</code> 변수에서 호출된 횟수를 추적한 다음 세미호스팅을 사용하여 <code>COUNT</code> 값을 호스트 콘솔에 출력합니다.</p>
<blockquote>
<p><strong>참고</strong>: 이 예제는 모든 Cortex-M 장치에서 실행할 수 있으며 QEMU에서도 실행할 수 있습니다.</p>
</blockquote>
<pre><code class="language-rust ignore">#![deny(unsafe_code)]
#![no_main]
#![no_std]

use panic_halt as _;

use core::fmt::Write;

use cortex_m::peripheral::syst::SystClkSource;
use cortex_m_rt::{entry, exception};
use cortex_m_semihosting::{
    debug,
    hio::{self, HStdout},
};

#[entry]
fn main() -&gt; ! {
    let p = cortex_m::Peripherals::take().unwrap();
    let mut syst = p.SYST;

    // 시스템 타이머를 1초마다 SysTick 예외를 트리거하도록 구성합니다
    syst.set_clock_source(SystClkSource::Core);
    // 이것은 기본 CPU 클록이 12MHz인 LM3S6965용으로 구성되었습니다
    syst.set_reload(12_000_000);
    syst.clear_current();
    syst.enable_counter();
    syst.enable_interrupt();

    loop {}
}

#[exception]
fn SysTick() {
    static mut COUNT: u32 = 0;
    static mut STDOUT: Option&lt;HStdout&gt; = None;

    *COUNT += 1;

    // 지연 초기화
    if STDOUT.is_none() {
        *STDOUT = hio::hstdout().ok();
    }

    if let Some(hstdout) = STDOUT.as_mut() {
        write!(hstdout, "{}", *COUNT).ok();
    }

    // 중요: 실제 하드웨어에서 실행 중이거나 디버거가 일관되지 않은 상태로 종료될 경우 이 `if` 블록을 생략하십시오
    if *COUNT == 9 {
        // QEMU 프로세스를 종료합니다
        debug::exit(debug::EXIT_SUCCESS);
    }
}</code></pre>
<pre><code class="language-console">tail -n5 Cargo.toml
</code></pre>
<p>`toml [dependencies] cortex-m = "0.5.7" cortex-m-rt = "0.6.3" panic-halt = "0.2.0" cortex-m-semihosting = "0.3.1"</p>
<pre><code></code></pre>
<pre><code class="language-text">$ cargo run --release
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb (..)
123456789
</code></pre>
<p>Discovery 보드에서 실행하면 OpenOCD 콘솔에 출력이 표시됩니다. 또한 카운트가 9에 도달해도 프로그램이 중지되지 <em>않습니다</em>.</p>
<h2 id="기본-예외-처리기"><a class="header" href="#기본-예외-처리기">기본 예외 처리기</a></h2>
<p><code>exception</code> 속성이 실제로 하는 일은 특정 예외에 대한 기본 예외 처리기를 _재정의_하는 것입니다. 특정 예외에 대한 처리기를 재정의하지 않으면 <code>DefaultHandler</code> 함수에서 처리되며 기본값은 다음과 같습니다.</p>
<pre><code class="language-rust ignore">fn DefaultHandler() {
    loop {}
}</code></pre>
<p>이 함수는 <code>cortex-m-rt</code> 크레이트에서 제공하며 <code>#[no_mangle]</code>로 표시되어 있으므로 "DefaultHandler"에 중단점을 설정하고 <em>처리되지 않은</em> 예외를 잡을 수 있습니다.</p>
<p><code>exception</code> 속성을 사용하여 이 <code>DefaultHandler</code>를 재정의할 수 있습니다.</p>
<pre><code class="language-rust ignore">#[exception]
fn DefaultHandler(irqn: i16) {
    // 사용자 지정 기본 처리기
}</code></pre>
<p><code>irqn</code> 인수는 서비스 중인 예외를 나타냅니다. 음수 값은 Cortex-M 예외가 서비스 중임을 나타내고 0 또는 양수 값은 장치별 예외(일명 인터럽트)가 서비스 중임을 나타냅니다.</p>
<h2 id="하드-폴트-처리기"><a class="header" href="#하드-폴트-처리기">하드 폴트 처리기</a></h2>
<p><code>HardFault</code> 예외는 약간 특별합니다. 이 예외는 프로그램이 잘못된 상태에 들어갈 때 발생하므로 처리기가 반환할 수 <em>없습니다</em>. 그렇게 하면 정의되지 않은 동작이 발생할 수 있기 때문입니다. 또한 런타임 크레이트는 사용자 정의 <code>HardFault</code> 처리기가 호출되기 전에 디버깅 가능성을 향상시키기 위해 약간의 작업을 수행합니다.</p>
<p>결과적으로 <code>HardFault</code> 처리기는 <code>fn(&amp;ExceptionFrame) -&gt; !</code> 시그니처를 가져야 합니다. 처리기의 인수는 예외에 의해 스택에 푸시된 레지스터에 대한 포인터입니다. 이러한 레지스터는 예외가 트리거된 순간의 프로세서 상태 스냅샷이며 하드 폴트를 진단하는 데 유용합니다.</p>
<p>다음은 잘못된 작업(존재하지 않는 메모리 위치 읽기)을 수행하는 예입니다.</p>
<blockquote>
<p><strong>참고</strong>: 이 프로그램은 QEMU에서 작동하지 않습니다. 즉, 충돌하지 않습니다. <code>qemu-system-arm -machine lm3s6965evb</code>는 메모리 로드를 확인하지 않고 잘못된 메모리 읽기 시 <code>0</code>을 반환하기 때문입니다.</p>
</blockquote>
<pre><code class="language-rust ignore">#![no_main]
#![no_std]

use panic_halt as _;

use core::fmt::Write;
use core::ptr;

use cortex_m_rt::{entry, exception, ExceptionFrame};
use cortex_m_semihosting::hio;

#[entry]
fn main() -&gt; ! {
    // 존재하지 않는 메모리 위치 읽기
    unsafe {
        ptr::read_volatile(0x3FFF_0000 as *const u32);
    }

    loop {}
}

#[exception]
fn HardFault(ef: &amp;ExceptionFrame) -&gt; ! {
    if let Ok(mut hstdout) = hio::hstdout() {
        writeln!(hstdout, "{:#?}", ef).ok();
    }

    loop {}
}</code></pre>
<p><code>HardFault</code> 처리기는 <code>ExceptionFrame</code> 값을 출력합니다. 이것을 실행하면 OpenOCD 콘솔에 다음과 같은 내용이 표시됩니다.</p>
<pre><code class="language-text">$ openocd
(..)
ExceptionFrame {
    r0: 0x3fff0000,
    r1: 0x00000003,
    r2: 0x080032e8,
    r3: 0x00000000,
    r12: 0x00000000,
    lr: 0x080016df,
    pc: 0x080016e2,
    xpsr: 0x61000000,
}
</code></pre>
<p><code>pc</code> 값은 예외 발생 시점의 프로그램 카운터 값이며 예외를 트리거한 명령어를 가리킵니다.</p>
<p>프로그램의 디스어셈블리를 보면 다음과 같습니다.</p>
<pre><code class="language-text">$ cargo objdump --bin app --release -- -d --no-show-raw-insn --print-imm-hex
(..)
ResetTrampoline:
 8000942:       movw    r0, #0xfffe
 8000946:       movt    r0, #0x3fff
 800094a:       ldr     r0, [r0]
 800094c:       b       #-0x4 &lt;ResetTrampoline+0xa&gt;
</code></pre>
<p>디스어셈블리에서 프로그램 카운터 <code>0x0800094a</code>의 값을 조회할 수 있습니다. 로드 작업(<code>ldr r0, [r0]</code>)이 예외를 발생시켰음을 알 수 있습니다. <code>ExceptionFrame</code>의 <code>r0</code> 필드는 당시 레지스터 <code>r0</code>의 값이 <code>0x3fff_fffe</code>였음을 알려줍니다.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../start/panicking.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../start/interrupts.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../start/panicking.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../start/interrupts.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../theme/language-picker.js"></script>


    </div>
    </body>
</html>
