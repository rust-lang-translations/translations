<!DOCTYPE HTML>
<html lang="ko" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Rc&lt;T&gt;, 참조 카운팅 스마트 포인터 - The Rust Programming Language</title>


        <!-- Custom HTML head -->

        <script async src="https://www.googletagmanager.com/gtag/js?id=G-L455DH98TK"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-L455DH98TK');
        </script>
        
        
        <script>
            (function () {
                // See these pages for details:
                // https://developers.google.com/search/docs/crawling-indexing/consolidate-duplicate-urls
                // https://developers.google.com/search/docs/crawling-indexing/javascript/javascript-seo-basics
        
                function gen_canonical_href(lang) {
        
                    let base = "https://rust-lang-translations.org/book";
        
                    let canonical_href;
                    if (lang == "en") {
                        canonical_href = `${base}/ch15-04-rc.md`;
                    } else {
                        canonical_href = `${base}/${lang}/ch15-04-rc.md`;
                    }
                    canonical_href = canonical_href.slice(0, -"md".length) + "html";
                    if (canonical_href.endsWith("/index.html")) {
                        canonical_href = canonical_href.slice(0, -"index.html".length);
                    }
                    return canonical_href;
                }
        
                const canonical_href = gen_canonical_href("ko");

                let link = document.createElement("link");
                link.rel = "canonical";
                link.href = canonical_href;
                document.head.appendChild(link);
        
        
                const langs = ["en"  , "ja"  , "ru"  , "ko" ];
        
                for (const lang of langs) {
                    const canonical_href = gen_canonical_href(lang);
        
                    let link = document.createElement("link");
                    link.rel = "alternate";
                    link.hreflang = lang;
                    link.href = canonical_href;
                    document.head.appendChild(link);
                }
            })()
        </script>
        

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="ferris.css">
        <link rel="stylesheet" href="theme/2018-edition.css">
        <link rel="stylesheet" href="theme/semantic-notes.css">
        <link rel="stylesheet" href="theme/listing.css">
        <link rel="stylesheet" href="theme/language-picker.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rust Programming Language</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang-translations/project" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="rct-the-reference-counted-smart-pointer"><a class="header" href="#rct-the-reference-counted-smart-pointer"><code>Rc&lt;T&gt;</code>, the Reference-Counted Smart Pointer</a></h2>
<p>In the majority of cases, ownership is clear: You know exactly which variable owns a given value. However, there are cases when a single value might have multiple owners. For example, in graph data structures, multiple edges might point to the same node, and that node is conceptually owned by all of the edges that point to it. A node shouldn’t be cleaned up unless it doesn’t have any edges pointing to it and so has no owners.</p>
<p>러스트의 <code>Rc&lt;T&gt;</code> 타입을 사용하여 명시적으로 다중 소유권을 활성화해야 합니다. <code>Rc&lt;T&gt;</code>는 _참조 카운팅(reference counting)_의 약자입니다. <code>Rc&lt;T&gt;</code> 타입은 값이 여전히 사용 중인지 결정하기 위해 그 값에 대한 참조 횟수를 추적합니다. 만약 값에 대한 참조가 0개라면, 어떤 참조도 무효화되지 않은 채로 그 값을 정리할 수 있습니다.</p>
<p>Imagine <code>Rc&lt;T&gt;</code> as a TV in a family room. When one person enters to watch TV, they turn it on. Others can come into the room and watch the TV. When the last person leaves the room, they turn off the TV because it’s no longer being used. If someone turns off the TV while others are still watching it, there would be an uproar from the remaining TV watchers!</p>
<p>프로그램의 여러 부분에서 읽을 수 있도록 힙에 데이터를 할당하고 싶지만, 컴파일 타임에 어떤 부분이 마지막으로 그 데이터를 사용할지 결정할 수 없을 때 <code>Rc&lt;T&gt;</code> 타입을 사용합니다. 만약 어떤 부분이 마지막에 끝날지 안다면, 그 부분을 데이터의 소유자로 만들면 컴파일 타임에 강제되는 일반적인 소유권 규칙이 적용될 것입니다.</p>
<p><code>Rc&lt;T&gt;</code>는 오직 단일 스레드 시나리오에서만 사용 가능하다는 점에 유의하세요. 16장에서 동시성을 논의할 때, 멀티스레드 프로그램에서 참조 카운팅을 하는 방법을 다룰 것입니다.</p>
<!-- Old headings. Do not remove or links may break. -->
<p><a id="using-rct-to-share-data"></a></p>
<h3 id="sharing-data"><a class="header" href="#sharing-data">Sharing Data</a></h3>
<p>Let’s return to our cons list example in Listing 15-5. Recall that we defined it using <code>Box&lt;T&gt;</code>. This time, we’ll create two lists that both share ownership of a third list. Conceptually, this looks similar to Figure 15-3.</p>
<p><img alt="A linked list with the label 'a' pointing to three elements. The first element contains the integer 5 and points to the second element. Th
e second element contains the integer 10 and points to the third element. The third element contains the value 'Nil' that signifies the end of the l
ist; it does not point anywhere. A linked list with the label 'b' points to an element that contains the integer 3 and points to the first element o
f list 'a'. A linked list with the label 'c' points to an element that contains the integer 4 and also points to the first element of list 'a' so th
at the tails of lists 'b' and 'c' are both list 'a'." src="img/trpl15-03.svg" class="center" /></p>
<p><span class="caption">그림 15-3: 세 번째 리스트 <code>a</code>를 공유 소유하는 두 리스트 <code>b</code>와 <code>c</code></span></p>
<p>We’ll create list <code>a</code> that contains <code>5</code> and then <code>10</code>. Then, we’ll make two more lists: <code>b</code> that starts with <code>3</code> and <code>c</code> that starts with <code>4</code>. Both the <code>b</code> and <code>c</code> lists will then continue on to the first <code>a</code> list containing <code>5</code> and <code>10</code>. In other words, both lists will share the first list containing <code>5</code> and <code>10</code>.</p>
<p>Trying to implement this scenario using our definition of <code>List</code> with <code>Box&lt;T&gt;</code> won’t work, as shown in Listing 15-17.</p>
<Listing number="15-17" file-name="src/main.rs" caption="Demonstrating that we’re not allowed to have two lists using `Box<T>` that try to share ownership of a third list">
<pre><code class="language-rust ignore does_not_compile">enum List {
    Cons(i32, Box&lt;List&gt;),
    Nil,
}

use crate::List::{Cons, Nil};

fn main() {
    let a = Cons(5, Box::new(Cons(10, Box::new(Nil))));
    let b = Cons(3, Box::new(a));
    let c = Cons(4, Box::new(a));
}</code></pre>
</Listing>
<p>이 코드를 컴파일하면 다음과 같은 에러가 발생합니다:</p>
<pre><code class="language-console">$ cargo run
   Compiling cons-list v0.1.0 (file:///projects/cons-list)
error[E0382]: use of moved value: `a`
  --&gt; src/main.rs:11:30
   |
 9 |     let a = Cons(5, Box::new(Cons(10, Box::new(Nil))));
   |         - move occurs because `a` has type `List`, which does not implement the `Copy` trait
10 |     let b = Cons(3, Box::new(a));
   |                              - value moved here
11 |     let c = Cons(4, Box::new(a));
   |                              ^ value used here after move
   |
note: if `List` implemented `Clone`, you could clone the value
  --&gt; src/main.rs:1:1
   |
 1 | enum List {
   | ^^^^^^^^^ consider implementing `Clone` for this type
...
10 |     let b = Cons(3, Box::new(a));
   |                              - you could clone this value

For more information about this error, try `rustc --explain E0382`.
error: could not compile `cons-list` (bin "cons-list") due to 1 previous error
</code></pre>
<p><code>Cons</code> 변종은 자신이 보유한 데이터를 소유하므로, 리스트 <code>b</code>를 생성할 때 <code>a</code>는 <code>b</code>로 이동하고 <code>b</code>가 <code>a</code>를 소유하게 됩니다. 그런 다음 <code>c</code>를 생성할 때 <code>a</code>를 다시 사용하려고 시도하면, <code>a</code>가 이미 이동되었기 때문에 허용되지 않습니다.</p>
<p><code>Cons</code>가 참조를 보유하도록 정의를 변경할 수도 있지만, 그렇게 하면 라이프타임 매개변수를 지정해야 합니다. 라이프타임 매개변수를 지정한다는 것은 리스트의 모든 요소가 전체 리스트만큼은 오래 살 것임을 명시하는 것입니다. 목록 15-17의 요소들과 리스트들이 바로 그런 경우지만, 모든 시나리오가 그렇지는 않습니다.</p>
<p>대신, 목록 15-18에서처럼 <code>Box&lt;T&gt;</code> 대신 <code>Rc&lt;T&gt;</code>를 사용하도록 <code>List</code> 정의를 변경하겠습니다. 이제 각 <code>Cons</code> 변종은 값 하나와 <code>List</code>를 가리키는 <code>Rc&lt;T&gt;</code>를 보유하게 됩니다. <code>b</code>를 생성할 때 <code>a</code>의 소유권을 가져오는 대신, <code>a</code>가 보유하고 있는 <code>Rc&lt;List&gt;</code>를 복제(clone)할 것입니다. 이렇게 하면 참조 횟수가 1에서 2로 증가하며, <code>a</code>와 <code>b</code>가 그 <code>Rc&lt;List&gt;</code> 안의 데이터에 대한 소유권을 공유하게 됩니다. 또한 <code>c</code>를 생성할 때도 <code>a</code>를 복제하여 참조 횟수를 2에서 3으로 늘릴 것입니다. <code>Rc::clone</code>을 호출할 때마다 <code>Rc&lt;List&gt;</code> 내부 데이터에 대한 참조 횟수가 증가하며, 참조 횟수가 0이 되지 않는 한 데이터는 정리되지 않을 것입니다.</p>
<Listing number="15-18" file-name="src/main.rs" caption="A definition of `List` that uses `Rc<T>`">
<pre><pre class="playground"><code class="language-rust edition2024">enum List {
    Cons(i32, Rc&lt;List&gt;),
    Nil,
}

use crate::List::{Cons, Nil};
use std::rc::Rc;

fn main() {
    let a = Rc::new(Cons(5, Rc::new(Cons(10, Rc::new(Nil)))));
    let b = Cons(3, Rc::clone(&amp;a));
    let c = Cons(4, Rc::clone(&amp;a));
}</code></pre></pre>
</Listing>
<p>We need to add a <code>use</code> statement to bring <code>Rc&lt;T&gt;</code> into scope because it’s not in the prelude. In <code>main</code>, we create the list holding <code>5</code> and <code>10</code> and store it in a new <code>Rc&lt;List&gt;</code> in <code>a</code>. Then, when we create <code>b</code> and <code>c</code>, we call the <code>Rc::clone</code> function and pass a reference to the <code>Rc&lt;List&gt;</code> in <code>a</code> as an argument.</p>
<p><code>Rc::clone(&amp;a)</code> 대신 <code>a.clone()</code>을 호출할 수도 있었겠지만, 이 경우에는 <code>Rc::clone</code>을 사용하는 것이 러스트의 관례입니다. <code>Rc::clone</code>의 구현은 대부분의 타입들이 구현하는 <code>clone</code>처럼 모든 데이터를 깊은 복사(deep copy)하지 않습니다. <code>Rc::clone</code> 호출은 참조 횟수만 증가시키며, 이는 시간이 오래 걸리지 않습니다. 데이터의 깊은 복사는 많은 시간이 걸릴 수 있습니다. 참조 카운팅을 위해 <code>Rc::clone</code>을 사용함으로써, 우리는 깊은 복사류의 클론과 참조 횟수만 증가시키는 종류의 클론을 시각적으로 구분할 수 있습니다. 코드에서 성능 문제를 찾을 때, 깊은 복사 클론만 고려하면 되고 <code>Rc::clone</code> 호출은 무시할 수 있습니다.</p>
<!-- Old headings. Do not remove or links may break. -->
<p><a id="cloning-an-rct-increases-the-reference-count"></a></p>
<h3 id="cloning-to-increase-the-reference-count"><a class="header" href="#cloning-to-increase-the-reference-count">Cloning to Increase the Reference Count</a></h3>
<p>Let’s change our working example in Listing 15-18 so that we can see the reference counts changing as we create and drop references to the <code>Rc&lt;List&gt;</code> in <code>a</code>.</p>
<p>In Listing 15-19, we’ll change <code>main</code> so that it has an inner scope around list <code>c</code>; then, we can see how the reference count changes when <code>c</code> goes out of scope.</p>
<Listing number="15-19" file-name="src/main.rs" caption="Printing the reference count">
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">enum List {
</span><span class="boring">    Cons(i32, Rc&lt;List&gt;),
</span><span class="boring">    Nil,
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">use crate::List::{Cons, Nil};
</span><span class="boring">use std::rc::Rc;
</span><span class="boring">
</span>// --생략--

fn main() {
    let a = Rc::new(Cons(5, Rc::new(Cons(10, Rc::new(Nil)))));
    println!("a 생성 후의 횟수 = {}", Rc::strong_count(&amp;a));
    let b = Cons(3, Rc::clone(&amp;a));
    println!("b 생성 후의 횟수 = {}", Rc::strong_count(&amp;a));
    {
        let c = Cons(4, Rc::clone(&amp;a));
        println!("c 생성 후의 횟수 = {}", Rc::strong_count(&amp;a));
    }
    println!("c가 스코프를 벗어난 후의 횟수 = {}", Rc::strong_count(&amp;a));
}</code></pre></pre>
</Listing>
<p>At each point in the program where the reference count changes, we print the reference count, which we get by calling the <code>Rc::strong_count</code> function. This function is named <code>strong_count</code> rather than <code>count</code> because the <code>Rc&lt;T&gt;</code> type also has a <code>weak_count</code>; we’ll see what <code>weak_count</code> is used for in <a href="ch15-06-reference-cycles.html#preventing-reference-cycles-turning-an-rct-into-a-weakt">“Preventing Reference Cycles Using <code>Weak&lt;T&gt;</code>”</a><!-- ignore -->.</p>
<p>이 코드는 다음과 같이 출력합니다:</p>
<pre><code class="language-console">$ cargo run
   Compiling cons-list v0.1.0 (file:///projects/cons-list)
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.45s
     Running `target/debug/cons-list`
count after creating a = 1
count after creating b = 2
count after creating c = 3
count after c goes out of scope = 2
</code></pre>
<p>We can see that the <code>Rc&lt;List&gt;</code> in <code>a</code> has an initial reference count of 1; then, each time we call <code>clone</code>, the count goes up by 1. When <code>c</code> goes out of scope, the count goes down by 1. We don’t have to call a function to decrease the reference count like we have to call <code>Rc::clone</code> to increase the reference count: The implementation of the <code>Drop</code> trait decreases the reference count automatically when an <code>Rc&lt;T&gt;</code> value goes out of scope.</p>
<p>What we can’t see in this example is that when <code>b</code> and then <code>a</code> go out of scope at the end of <code>main</code>, the count is 0, and the <code>Rc&lt;List&gt;</code> is cleaned up completely. Using <code>Rc&lt;T&gt;</code> allows a single value to have multiple owners, and the count ensures that the value remains valid as long as any of the owners still exist.</p>
<p>Via immutable references, <code>Rc&lt;T&gt;</code> allows you to share data between multiple parts of your program for reading only. If <code>Rc&lt;T&gt;</code> allowed you to have multiple mutable references too, you might violate one of the borrowing rules discussed in Chapter 4: Multiple mutable borrows to the same place can cause data races and inconsistencies. But being able to mutate data is very useful! In the next section, we’ll discuss the interior mutability pattern and the <code>RefCell&lt;T&gt;</code> type that you can use in conjunction with an <code>Rc&lt;T&gt;</code> to work with this immutability restriction.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ch15-03-drop.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="ch15-05-interior-mutability.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ch15-03-drop.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="ch15-05-interior-mutability.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="ferris.js"></script>
        <script src="theme/language-picker.js"></script>


    </div>
    </body>
</html>
